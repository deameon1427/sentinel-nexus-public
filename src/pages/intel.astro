---
import Layout from '../layouts/Layout.astro';

// Feed data structure
interface FeedItem {
  id: string;
  title: string;
  link: string;
  source: string;
  source_url: string;
  published: string;
  summary: string;
}

interface FeedData {
  updated_at: string;
  categories: {
    security: FeedItem[];
    ai: FeedItem[];
    vulnerabilities: FeedItem[];
    governance: FeedItem[];
  };
}

// Default empty data for local development
let feedData: FeedData = {
  updated_at: '',
  categories: {
    security: [],
    ai: [],
    vulnerabilities: [],
    governance: []
  }
};

// In production, this file is populated by n8n workflow
// For local dev, we use empty data or you can create a sample file
try {
  // This path works during Astro build on the server
  const fs = await import('node:fs');
  const path = '/var/lib/sentinel-nexus/data/intel/feeds.json';
  if (fs.existsSync(path)) {
    const content = fs.readFileSync(path, 'utf-8');
    feedData = JSON.parse(content);
  }
} catch (e) {
  // Fallback for local development - use sample data
  console.log('Using empty feed data (local dev)');
}

const categories = [
  { id: 'security', label: 'Security News', description: 'Latest cybersecurity news and threats' },
  { id: 'ai', label: 'AI & Cloud', description: 'AI security and cloud platform updates' },
  { id: 'vulnerabilities', label: 'Vulnerabilities', description: 'CVEs, advisories, and patches' },
  { id: 'governance', label: 'GRC Updates', description: 'Governance, risk, and compliance news' }
] as const;

function formatDate(dateString: string): string {
  if (!dateString) return '';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric'
  });
}

function formatUpdatedAt(dateString: string): string {
  if (!dateString) return 'Not yet updated';
  const date = new Date(dateString);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
}
---

<Layout
  title="Security & AI Intelligence | Sentinel Nexus"
  description="Curated security, AI, and governance news from trusted sources. Updated daily."
>
  <section class="intel-page">
    <div class="container">
      <header class="intel-header">
        <h1>Security & AI Intelligence</h1>
        <p class="intel-description">
          Curated news from trusted cybersecurity and AI sources. Stay informed about threats, vulnerabilities, and regulatory updates.
        </p>
        <div class="intel-meta">
          <span class="last-updated">Last updated: {formatUpdatedAt(feedData.updated_at)}</span>
        </div>
      </header>

      {feedData.updated_at ? (
        <div class="feed-grid">
          {categories.map(cat => {
            const items = feedData.categories[cat.id] || [];
            return (
              <section class="feed-category">
                <div class="category-header">
                  <h2>{cat.label}</h2>
                  <span class="category-count">{items.length} items</span>
                </div>
                <p class="category-description">{cat.description}</p>

                {items.length > 0 ? (
                  <ul class="feed-list">
                    {items.slice(0, 10).map(item => (
                      <li class="feed-item">
                        <a href={item.link} target="_blank" rel="noopener noreferrer">
                          <span class="feed-title">{item.title}</span>
                          <span class="feed-meta">
                            <span class="feed-source">{item.source}</span>
                            <span class="feed-date">{formatDate(item.published)}</span>
                          </span>
                        </a>
                      </li>
                    ))}
                  </ul>
                ) : (
                  <p class="no-items">No recent items</p>
                )}
              </section>
            );
          })}
        </div>
      ) : (
        <div class="empty-state">
          <h2>Feed data coming soon</h2>
          <p>The intelligence feed is being configured. Check back shortly for curated security and AI news.</p>
        </div>
      )}

      <section class="intel-cta">
        <h2>Want personalized threat intelligence?</h2>
        <p>Our MDR services include custom threat feeds tailored to your industry and technology stack.</p>
        <a href="/#contact" class="btn btn-primary btn-large">Learn More</a>
      </section>
    </div>
  </section>
</Layout>

<style>
  .intel-page {
    padding: 8rem 0 4rem;
    min-height: 100vh;
  }

  .intel-header {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  .intel-header h1 {
    font-size: clamp(2rem, 4vw, 2.75rem);
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .intel-description {
    font-size: 1.125rem;
    color: var(--color-text-muted);
    max-width: 600px;
    margin: 0 auto 1.5rem;
  }

  .intel-meta {
    display: flex;
    justify-content: center;
    gap: 2rem;
  }

  .last-updated {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    background: var(--color-bg-card);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 1px solid var(--color-border);
  }

  .feed-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2rem;
    margin-bottom: 4rem;
  }

  .feed-category {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .category-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
  }

  .category-count {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    background: var(--color-bg-secondary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .category-description {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .feed-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 400px;
    overflow-y: auto;
  }

  .feed-item a {
    display: block;
    padding: 0.75rem;
    background: var(--color-bg-secondary);
    border-radius: 8px;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .feed-item a:hover {
    background: var(--color-bg);
    transform: translateX(4px);
  }

  .feed-title {
    display: block;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-text);
    line-height: 1.4;
    margin-bottom: 0.5rem;
  }

  .feed-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .feed-source {
    background: var(--color-bg-card);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
  }

  .no-items {
    color: var(--color-text-muted);
    font-style: italic;
    text-align: center;
    padding: 2rem;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    margin-bottom: 4rem;
  }

  .empty-state h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .empty-state p {
    color: var(--color-text-muted);
  }

  .intel-cta {
    text-align: center;
    padding: 3rem;
    background: linear-gradient(135deg, var(--color-bg-card) 0%, var(--color-bg-secondary) 100%);
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }

  .intel-cta h2 {
    font-size: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .intel-cta p {
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Custom scrollbar for feed lists */
  .feed-list::-webkit-scrollbar {
    width: 6px;
  }

  .feed-list::-webkit-scrollbar-track {
    background: var(--color-bg-secondary);
    border-radius: 3px;
  }

  .feed-list::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
  }

  .feed-list::-webkit-scrollbar-thumb:hover {
    background: var(--color-text-muted);
  }

  @media (max-width: 1024px) {
    .feed-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .intel-page {
      padding: 6rem 0 3rem;
    }

    .feed-category {
      padding: 1rem;
    }

    .feed-list {
      max-height: 300px;
    }
  }
</style>
